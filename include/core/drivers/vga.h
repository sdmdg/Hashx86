#ifndef VGA_H
#define VGA_H

#include <types.h>
#include <core/interrupts.h>
#include <core/ports.h>
#include <console.h>
#include <core/driver.h>
#include <gui/fonts/font.h>
#include <gui/icons.h>

/**
 * @brief Class for handling VGA (Video Graphics Array) graphics.
 * 
 * This class provides functions for setting video modes, drawing graphics, and handling
 * pixel manipulation in VGA mode 13h (320x200, 256 colors).
 */
class VideoGraphicsArray
{
protected:
    /// VGA port registers for controlling video settings
    Port8Bit miscPort;
    Port8Bit crtcIndexPort;
    Port8Bit crtcDataPort;
    Port8Bit sequencerIndexPort;
    Port8Bit sequencerDataPort;
    Port8Bit graphicsControllerIndexPort;
    Port8Bit graphicsControllerDataPort;
    Port8Bit attributeControllerIndexPort;
    Port8Bit attributeControllerReadPort;
    Port8Bit attributeControllerWritePort;
    Port8Bit attributeControllerResetPort;
    Port8Bit paletteIndexPort;
    Port8Bit paletteDataPort;

    /**
     * @brief Writes a set of VGA registers to configure the graphics mode.
     * 
     * @param registers Pointer to an array of register values.
     */
    void WriteRegisters(uint8_t* registers);

    /**
     * @brief Retrieves the memory segment where the VGA framebuffer is located.
     * 
     * @return Pointer to the framebuffer memory.
     */
    uint8_t* GetFrameBufferSegment();

    /// Default VGA screen resolution
    uint32_t VGA_SCREEN_WIDTH = 320;
    uint32_t VGA_SCREEN_HEIGHT = 200;
    
public:
    /**
     * @brief Constructs a VideoGraphicsArray instance and initializes VGA registers.
     */
    VideoGraphicsArray();

    /**
     * @brief Destructor for the VideoGraphicsArray class.
     */
    ~VideoGraphicsArray();
    
    /**
     * @brief Checks if the requested resolution and color depth are supported.
     * 
     * @param width Screen width.
     * @param height Screen height.
     * @param colordepth Bits per pixel.
     * @return True if the mode is supported, false otherwise.
     */
    virtual bool SupportsMode(uint32_t width, uint32_t height, uint32_t colordepth);

    /**
     * @brief Sets the VGA graphics mode.
     * 
     * @param width Screen width.
     * @param height Screen height.
     * @param colordepth Bits per pixel.
     * @return True if the mode was successfully set, false otherwise.
     */
    virtual bool SetMode(uint32_t width, uint32_t height, uint32_t colordepth);

    /**
     * @brief Sets the VGA palette colors.
     * 
     * @param palette 2D array representing RGB values for 256 colors.
     */
    void SetVGAPalette(const uint8_t palette[256][3]);

    /**
     * @brief Finds the closest matching VGA color index for an RGB color.
     * 
     * @param r Red component (0-255).
     * @param g Green component (0-255).
     * @param b Blue component (0-255).
     * @return The closest matching VGA color index.
     */
    uint8_t GetClosestColorIndex(uint8_t r, uint8_t g, uint8_t b);

    /**
     * @brief Copies the back buffer contents to the framebuffer (screen update).
     */
    void Flush();

    /**
     * @brief Draws a pixel at (x, y) with specified RGB color.
     * 
     * @param x X-coordinate.
     * @param y Y-coordinate.
     * @param r Red component (0-255).
     * @param g Green component (0-255).
     * @param b Blue component (0-255).
     */
    virtual void PutPixel(int32_t x, int32_t y, uint8_t r, uint8_t g, uint8_t b);

    /**
     * @brief Draws a pixel at (x, y) using a color index from the VGA palette.
     * 
     * @param x X-coordinate.
     * @param y Y-coordinate.
     * @param colorIndex VGA color index (0-255).
     */
    virtual void PutPixel(int32_t x, int32_t y, uint8_t colorIndex);

    /**
     * @brief Draws a bitmap image at the specified coordinates.
     * 
     * @param x X-coordinate of the top-left corner.
     * @param y Y-coordinate of the top-left corner.
     * @param bitmapData Pointer to the bitmap data.
     * @param bitmapWidth Width of the bitmap.
     * @param bitmapHeight Height of the bitmap.
     */
    void DrawBitmap(int32_t x, int32_t y, const uint8_t* bitmapData, int32_t bitmapWidth, int32_t bitmapHeight);

    /**
     * @brief Fills a rectangle with a solid color.
     * 
     * @param x X-coordinate of the top-left corner.
     * @param y Y-coordinate of the top-left corner.
     * @param w Width of the rectangle.
     * @param h Height of the rectangle.
     * @param colorIndex VGA color index (0-255).
     */
    virtual void FillRectangle(uint32_t x, uint32_t y, uint32_t w, uint32_t h, uint8_t colorIndex);

    /**
     * @brief Draws a rectangular outline with a specified color.
     */
    void DrawRectangle(uint32_t x, uint32_t y, uint32_t w, uint32_t h, uint8_t colorIndex);

    /**
     * @brief Fills a rounded rectangle with a solid color.
     */
    void FillRoundedRectangle(uint32_t x, uint32_t y, uint32_t w, uint32_t h, uint32_t radius, uint8_t colorIndex);

    /**
     * @brief Draws the outline of a circle.
     */
    void DrawCircle(uint32_t cx, uint32_t cy, uint32_t radius, uint8_t colorIndex);

    /**
     * @brief Fills a circle with a solid color.
     */
    void FillCircle(uint32_t cx, uint32_t cy, uint32_t radius, uint8_t colorIndex);

    /**
     * @brief Draws a horizontal line.
     */
    void DrawHorizontalLine(int32_t x, int32_t y, int32_t length, uint8_t colorIndex);

    /**
     * @brief Draws a vertical line.
     */
    void DrawVerticalLine(int32_t x, int32_t y, int32_t length, uint8_t colorIndex);

    /**
     * @brief Draws a character at the specified coordinates.
     */
    void DrawCharacter(int32_t x, int32_t y, char c, uint8_t colorIndex);

    /**
     * @brief Draws a string of characters.
     */
    void DrawString(int32_t x, int32_t y, const char* str, uint8_t colorIndex);
};

// Standard 256-color VGA palette (3 bytes per color)
const uint8_t palette[256][3] = {
        {0x00,0x00,0x00},
        {0x00,0x00,0xaa},
        {0x00,0xaa,0x00},
        {0x00,0xaa,0xaa},
        {0xaa,0x00,0x00},
        {0xaa,0x00,0xaa},
        {0xaa,0x55,0x00},
        {0xaa,0xaa,0xaa},
        {0x55,0x55,0x55},
        {0x55,0x55,0xff},
        {0x55,0xff,0x55},
        {0x55,0xff,0xff},
        {0xff,0x55,0x55},
        {0xff,0x55,0xff},
        {0xff,0xff,0x55},
        {0xff,0xff,0xff},
        {0x00,0x00,0x00},
        {0x14,0x14,0x14},
        {0x20,0x20,0x20},
        {0x2c,0x2c,0x2c},
        {0x38,0x38,0x38},
        {0x45,0x45,0x45},
        {0x51,0x51,0x51},
        {0x61,0x61,0x61},
        {0x71,0x71,0x71},
        {0x82,0x82,0x82},
        {0x92,0x92,0x92},
        {0xa2,0xa2,0xa2},
        {0xb6,0xb6,0xb6},
        {0xcb,0xcb,0xcb},
        {0xe3,0xe3,0xe3},
        {0xff,0xff,0xff},
        {0x00,0x00,0xff},
        {0x41,0x00,0xff},
        {0x7d,0x00,0xff},
        {0xbe,0x00,0xff},
        {0xff,0x00,0xff},
        {0xff,0x00,0xbe},
        {0xff,0x00,0x7d},
        {0xff,0x00,0x41},
        {0xff,0x00,0x00},
        {0xff,0x41,0x00},
        {0xff,0x7d,0x00},
        {0xff,0xbe,0x00},
        {0xff,0xff,0x00},
        {0xbe,0xff,0x00},
        {0x7d,0xff,0x00},
        {0x41,0xff,0x00},
        {0x00,0xff,0x00},
        {0x00,0xff,0x41},
        {0x00,0xff,0x7d},
        {0x00,0xff,0xbe},
        {0x00,0xff,0xff},
        {0x00,0xbe,0xff},
        {0x00,0x7d,0xff},
        {0x00,0x41,0xff},
        {0x7d,0x7d,0xff},
        {0x9e,0x7d,0xff},
        {0xbe,0x7d,0xff},
        {0xdf,0x7d,0xff},
        {0xff,0x7d,0xff},
        {0xff,0x7d,0xdf},
        {0xff,0x7d,0xbe},
        {0xff,0x7d,0x9e},
        {0xff,0x7d,0x7d},
        {0xff,0x9e,0x7d},
        {0xff,0xbe,0x7d},
        {0xff,0xdf,0x7d},
        {0xff,0xff,0x7d},
        {0xdf,0xff,0x7d},
        {0xbe,0xff,0x7d},
        {0x9e,0xff,0x7d},
        {0x7d,0xff,0x7d},
        {0x7d,0xff,0x9e},
        {0x7d,0xff,0xbe},
        {0x7d,0xff,0xdf},
        {0x7d,0xff,0xff},
        {0x7d,0xdf,0xff},
        {0x7d,0xbe,0xff},
        {0x7d,0x9e,0xff},
        {0xb6,0xb6,0xff},
        {0xc7,0xb6,0xff},
        {0xdb,0xb6,0xff},
        {0xeb,0xb6,0xff},
        {0xff,0xb6,0xff},
        {0xff,0xb6,0xeb},
        {0xff,0xb6,0xdb},
        {0xff,0xb6,0xc7},
        {0xff,0xb6,0xb6},
        {0xff,0xc7,0xb6},
        {0xff,0xdb,0xb6},
        {0xff,0xeb,0xb6},
        {0xff,0xff,0xb6},
        {0xeb,0xff,0xb6},
        {0xdb,0xff,0xb6},
        {0xc7,0xff,0xb6},
        {0xb6,0xff,0xb6},
        {0xb6,0xff,0xc7},
        {0xb6,0xff,0xdb},
        {0xb6,0xff,0xeb},
        {0xb6,0xff,0xff},
        {0xb6,0xeb,0xff},
        {0xb6,0xdb,0xff},
        {0xb6,0xc7,0xff},
        {0x00,0x00,0x71},
        {0x1c,0x00,0x71},
        {0x38,0x00,0x71},
        {0x55,0x00,0x71},
        {0x71,0x00,0x71},
        {0x71,0x00,0x55},
        {0x71,0x00,0x38},
        {0x71,0x00,0x1c},
        {0x71,0x00,0x00},
        {0x71,0x1c,0x00},
        {0x71,0x38,0x00},
        {0x71,0x55,0x00},
        {0x71,0x71,0x00},
        {0x55,0x71,0x00},
        {0x38,0x71,0x00},
        {0x1c,0x71,0x00},
        {0x00,0x71,0x00},
        {0x00,0x71,0x1c},
        {0x00,0x71,0x38},
        {0x00,0x71,0x55},
        {0x00,0x71,0x71},
        {0x00,0x55,0x71},
        {0x00,0x38,0x71},
        {0x00,0x1c,0x71},
        {0x38,0x38,0x71},
        {0x45,0x38,0x71},
        {0x55,0x38,0x71},
        {0x61,0x38,0x71},
        {0x71,0x38,0x71},
        {0x71,0x38,0x61},
        {0x71,0x38,0x55},
        {0x71,0x38,0x45},
        {0x71,0x38,0x38},
        {0x71,0x45,0x38},
        {0x71,0x55,0x38},
        {0x71,0x61,0x38},
        {0x71,0x71,0x38},
        {0x61,0x71,0x38},
        {0x55,0x71,0x38},
        {0x45,0x71,0x38},
        {0x38,0x71,0x38},
        {0x38,0x71,0x45},
        {0x38,0x71,0x55},
        {0x38,0x71,0x61},
        {0x38,0x71,0x71},
        {0x38,0x61,0x71},
        {0x38,0x55,0x71},
        {0x38,0x45,0x71},
        {0x51,0x51,0x71},
        {0x59,0x51,0x71},
        {0x61,0x51,0x71},
        {0x69,0x51,0x71},
        {0x71,0x51,0x71},
        {0x71,0x51,0x69},
        {0x71,0x51,0x61},
        {0x71,0x51,0x59},
        {0x71,0x51,0x51},
        {0x71,0x59,0x51},
        {0x71,0x61,0x51},
        {0x71,0x69,0x51},
        {0x71,0x71,0x51},
        {0x69,0x71,0x51},
        {0x61,0x71,0x51},
        {0x59,0x71,0x51},
        {0x51,0x71,0x51},
        {0x51,0x71,0x59},
        {0x51,0x71,0x61},
        {0x51,0x71,0x69},
        {0x51,0x71,0x71},
        {0x51,0x69,0x71},
        {0x51,0x61,0x71},
        {0x51,0x59,0x71},
        {0x00,0x00,0x41},
        {0x10,0x00,0x41},
        {0x20,0x00,0x41},
        {0x30,0x00,0x41},
        {0x41,0x00,0x41},
        {0x41,0x00,0x30},
        {0x41,0x00,0x20},
        {0x41,0x00,0x10},
        {0x41,0x00,0x00},
        {0x41,0x10,0x00},
        {0x41,0x20,0x00},
        {0x41,0x30,0x00},
        {0x41,0x41,0x00},
        {0x30,0x41,0x00},
        {0x20,0x41,0x00},
        {0x10,0x41,0x00},
        {0x00,0x41,0x00},
        {0x00,0x41,0x10},
        {0x00,0x41,0x20},
        {0x00,0x41,0x30},
        {0x00,0x41,0x41},
        {0x00,0x30,0x41},
        {0x00,0x20,0x41},
        {0x00,0x10,0x41},
        {0x20,0x20,0x41},
        {0x28,0x20,0x41},
        {0x30,0x20,0x41},
        {0x38,0x20,0x41},
        {0x41,0x20,0x41},
        {0x41,0x20,0x38},
        {0x41,0x20,0x30},
        {0x41,0x20,0x28},
        {0x41,0x20,0x20},
        {0x41,0x28,0x20},
        {0x41,0x30,0x20},
        {0x41,0x38,0x20},
        {0x41,0x41,0x20},
        {0x38,0x41,0x20},
        {0x30,0x41,0x20},
        {0x28,0x41,0x20},
        {0x20,0x41,0x20},
        {0x20,0x41,0x28},
        {0x20,0x41,0x30},
        {0x20,0x41,0x38},
        {0x20,0x41,0x41},
        {0x20,0x38,0x41},
        {0x20,0x30,0x41},
        {0x20,0x28,0x41},
        {0x2c,0x2c,0x41},
        {0x30,0x2c,0x41},
        {0x34,0x2c,0x41},
        {0x3c,0x2c,0x41},
        {0x41,0x2c,0x41},
        {0x41,0x2c,0x3c},
        {0x41,0x2c,0x34},
        {0x41,0x2c,0x30},
        {0x41,0x2c,0x2c},
        {0x41,0x30,0x2c},
        {0x41,0x34,0x2c},
        {0x41,0x3c,0x2c},
        {0x41,0x41,0x2c},
        {0x3c,0x41,0x2c},
        {0x34,0x41,0x2c},
        {0x30,0x41,0x2c},
        {0x2c,0x41,0x2c},
        {0x2c,0x41,0x30},
        {0x2c,0x41,0x34},
        {0x2c,0x41,0x3c},
        {0x2c,0x41,0x41},
        {0x2c,0x3c,0x41},
        {0x2c,0x34,0x41},
        {0x2c,0x30,0x41},
        {0x00,0x00,0x00},
        {0x00,0x00,0x00},
        {0x00,0x00,0x00},
        {0x00,0x00,0x00},
        {0x00,0x00,0x00},
        {0x00,0x00,0x00},
        {0x00,0x00,0x00},
        {0x00,0x00,0x00}
    };

#endif // VGA_H
