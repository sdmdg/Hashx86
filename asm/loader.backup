#
#  @file        loader.s
#  @brief       Main loader of #x86
#  
#  @date        01/02/2025
#  @version     1.0.0-beta
#

# Refer to https://www.gnu.org/software/grub/manual/multiboot/multiboot.html#Header-layout for more info.

# ---------------------------------------------------------------------------------------------- #
# Multiboot header (VBE VESA Graphics with 1152x864x32) NOTE : If you want to use VBE graphics,  #
#                                                              uncomment this section            #
# ---------------------------------------------------------------------------------------------- #
.set ALIGN,    1 << 0						# align loaded modules on page boundaries            #
.set MEMINFO,  1 << 1						# provide memory map                                 #
.set VIDINFO,  1 << 2						# OS wants video mode set                            #
#                                                                                                #
.set FLAGS,    ALIGN | MEMINFO | VIDINFO	# this is the multiboot 'flag' field                 #
.set MAGIC,    0x1BADB002					# 'magic number' lets bootloader find the header     #
.set CHECKSUM, -(MAGIC + FLAGS)				# checksum required                                  #
#                                                                                                #
# NOTE :                                                                                         #
#     *) Yes, I hard-coded the VESA Graphics config into this assembly file because I'm lazy.    #
#     *) If future me wants to make this configurable, too bad.                                  #
#                                                                              - Past me         #
#                                                                                  :)            #
#                                                                                                #
.section .multiboot                                                                              #
    .long MAGIC                             # Store the magic number                             #
    .long FLAGS                             # Store the flags value                              #
    .long CHECKSUM                          # Store the checksum value                           #
    .long 0, 0, 0, 0, 0					    # This is load address stuff we don't care for       #
    .long 0									# Set graphics mode                                  #
    .long 1152, 864, 32						# Width, height, depth                               #
# ---------------------------------------------------------------------------------------------- #


# ---------------------------------------------------------------------------------------------- #
# Multiboot header (VGA)  NOTE : If you want to use ugly VGA graphics, uncomment this section    #
# ---------------------------------------------------------------------------------------------- #
#.set MAGIC, 0x1badb002           # Magic number (used by bootloader to identify a valid kernel) #
#.set FLAGS, (1<<0 | 1<<1)        # Flags used by the bootloader (e.g. memory map, module info)  #
#.set CHECKSUM, -(MAGIC + FLAGS)  # The checksum                                                 #
#                                                                                                #
#.section .multiboot                                                                             #
#    .long MAGIC       # Store the magic number                                                  #
#    .long FLAGS       # Store the flags value                                                   #
#    .long CHECKSUM    # Store the checksum value                                                #
# ---------------------------------------------------------------------------------------------- #

# Define the text section where executable code is placed
.section .text
.extern kernelMain        # Declare an external reference to the kernel's entry point function (kernelMain)
.extern callConstructors  # Declare an external reference for calling constructors (C++ global/static constructors)
.global loader            # Make the loader function globally accessible

# The loader function is the entry point executed after the bootloader loads the kernel
loader:
    mov $kernel_stack, %esp   # Set the stack pointer to the beginning of the kernel stack
    call callConstructors     # Call the constructor functions
    
    push %eax                 # Save the value of EAX register (for passing data)
    push %ebx                 # Save the value of EBX register (for passing data)

    call kernelMain           # Call the kernel's main entry function

# Infinite loop to halt the CPU if something goes wrong
_stop:
    cli                       # Clear interrupts
    hlt                       # Halt the CPU
    jmp _stop                 # Jump to _stop, causing an infinite loop

# Define the BSS section where uninitialized data
.section .bss
.space 32*1024*1024;          # Allocate 8 MB of space for the kernel's stack

kernel_stack:                 # Label for the start of the kernel stack
